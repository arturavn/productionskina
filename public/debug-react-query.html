<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug React Query - Orders</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .info {
            background: #cce7ff;
            border-color: #99d6ff;
            color: #004085;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug React Query - Orders</h1>
        <p>Verificar como o React Query est√° processando os dados dos pedidos.</p>
        
        <div>
            <button class="button" onclick="testDirectAPI()">1. Testar API Direta</button>
            <button class="button" onclick="simulateReactQuery()">2. Simular React Query</button>
            <button class="button" onclick="checkReactQueryCache()">3. Verificar Cache RQ</button>
            <button class="button" onclick="goToProfile()">4. Ir para Perfil</button>
        </div>
        
        <div id="result" class="result" style="display: none;"></div>
    </div>

    <script>
        function showResult(message, type = 'info') {
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.className = `result ${type}`;
            resultDiv.textContent = message;
        }

        async function testDirectAPI() {
            try {
                const token = localStorage.getItem('auth_token');
                if (!token) {
                    showResult('‚ùå Token n√£o encontrado. Fa√ßa login primeiro.', 'error');
                    return;
                }
                
                showResult('üîÑ Testando API direta...', 'info');
                
                const response = await fetch('/api/orders?page=1&limit=10', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    const ordersCount = data.data?.orders?.length || 0;
                    showResult(`‚úÖ API Direta - Sucesso!\n\nStatus: ${response.status}\nPedidos encontrados: ${ordersCount}\n\nEstrutura completa:\n${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    showResult(`‚ùå API Direta - Erro:\n\nStatus: ${response.status}\nResposta: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå Erro na API direta: ${error.message}`, 'error');
            }
        }

        async function simulateReactQuery() {
            try {
                const token = localStorage.getItem('auth_token');
                if (!token) {
                    showResult('‚ùå Token n√£o encontrado. Fa√ßa login primeiro.', 'error');
                    return;
                }
                
                showResult('üîÑ Simulando comportamento do React Query...', 'info');
                
                // Simular o que o React Query faz
                const apiService = {
                    getOrders: async (params) => {
                        const queryParams = new URLSearchParams();
                        if (params?.page) queryParams.append('page', params.page.toString());
                        if (params?.limit) queryParams.append('limit', params.limit.toString());
                        
                        const url = `/api/orders${queryParams.toString() ? '?' + queryParams.toString() : ''}`;
                        
                        const response = await fetch(url, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        return response.json();
                    }
                };
                
                // Chamar como o React Query faria
                const result = await apiService.getOrders({ page: 1, limit: 10 });
                
                // Simular o que o componente UserOrders faz
                const ordersData = result; // Isso √© o que o React Query retorna
                const orders = ordersData?.data?.orders || [];
                const pagination = ordersData?.data?.pagination;
                
                showResult(`‚úÖ Simula√ß√£o React Query - Sucesso!\n\nDados retornados pelo 'queryFn':\n${JSON.stringify(result, null, 2)}\n\nüìä Processamento no componente:\n- ordersData: ${typeof ordersData}\n- orders extra√≠dos: ${orders.length} pedidos\n- pagination: ${pagination ? 'encontrada' : 'n√£o encontrada'}\n\nOrders array:\n${JSON.stringify(orders, null, 2)}`, 'success');
                
            } catch (error) {
                showResult(`‚ùå Erro na simula√ß√£o: ${error.message}`, 'error');
            }
        }

        function checkReactQueryCache() {
            // Tentar acessar o cache do React Query
            let cacheInfo = 'üîç Verificando cache do React Query:\n\n';
            
            // Verificar se h√° alguma refer√™ncia global
            if (window.ReactQuery) {
                cacheInfo += '‚úÖ window.ReactQuery encontrado\n';
            } else {
                cacheInfo += '‚ùå window.ReactQuery n√£o encontrado\n';
            }
            
            if (window.__REACT_QUERY_STATE__) {
                cacheInfo += '‚úÖ window.__REACT_QUERY_STATE__ encontrado\n';
            } else {
                cacheInfo += '‚ùå window.__REACT_QUERY_STATE__ n√£o encontrado\n';
            }
            
            // Verificar localStorage para cache persistido
            const keys = Object.keys(localStorage);
            const reactQueryKeys = keys.filter(key => key.includes('react-query') || key.includes('query'));
            
            if (reactQueryKeys.length > 0) {
                cacheInfo += `\nüì¶ Chaves relacionadas no localStorage (${reactQueryKeys.length}):\n`;
                reactQueryKeys.forEach(key => {
                    cacheInfo += `- ${key}\n`;
                });
            } else {
                cacheInfo += '\n‚ùå Nenhuma chave do React Query no localStorage\n';
            }
            
            // Verificar se h√° dados de orders no localStorage
            const authToken = localStorage.getItem('auth_token');
            cacheInfo += `\nüîë Token de auth: ${authToken ? 'presente' : 'ausente'}`;
            
            showResult(cacheInfo, 'info');
        }

        function goToProfile() {
            window.location.href = '/perfil';
        }

        // Auto-executar ao carregar
        window.onload = function() {
            showResult('üìã P√°gina carregada. Use os bot√µes para debugar o React Query.', 'info');
        };
    </script>
</body>
</html>